<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js" integrity="sha512-PU5S6BA03fRv1Q5fpwXjg5nlRrgdoguZ74urFInkbABMCENyx5oP3hrDzYMMPh3qdLdknIvrGj3yqZ4JuU7Nag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Chatting</title>
  </head>
  <body>
    <form action="" id="regUserForm">
      <input type="text" id="userNameInput" placeholder="Digite seu nome" data-testid="nickname-box">
      <button data-testid="nickname-button">Editar nome de usuário</button>
    </form>

    <ul id="users"></ul>

    <form action="" id="messageForm">
      <input type="text" id="messageInput" placeholder="Digite algo" data-testid="message-box">
      <button data-testid="send-button">Enviar</button>
    </form>

    <ul id="messages"></ul>

    <script>

      const socket = io('http://localhost:3000');

      // Referência: https://www.webtutorial.com.br/funcao-para-gerar-uma-string-aleatoria-random-com-caracteres-especificos-em-javascript/
      const generateUserName = (length) => {
        let randomString = '';
        const char = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        for (let i = 0; i < length; i++) {
          randomString += char.charAt(Math.floor(Math.random() * char.length));
        }
        return randomString;
      }

      let randomUserName = generateUserName(16);

      const userNameForm = document.querySelector('#regUserForm');
      const userNameInput = document.querySelector('#userNameInput');

      userNameForm.addEventListener('submit', (e) => {

        e.preventDefault();

        socket.emit('updateUserName', userNameInput.value);

        userNameInput.value = ''
        return false;
      });

      const showUserName = (users) => {
        console.log(users)
        const userList = document.querySelector('#users');
        userList.innerHTML = '';
        users.map((user) => {
          const userList = document.querySelector('#users');
          const userListLi = document.createElement('li');

          userListLi.classList.add('userName');
          userListLi.setAttribute('data-testid', 'online-user');
          userListLi.setAttribute('id', user.userId);
          userListLi.innerText = user.nickname;
          userList.appendChild(userListLi);
        });


      }

      socket.emit('userLogin', randomUserName);

      socket.on('userLogin', (users) => {
        showUserName(users);
      });

      socket.on('updateUserName', (users) => {
        showUserName(users);
      });

      const form = document.querySelector('#messageForm');
      const inputMessage = document.querySelector('#messageInput');

      form.addEventListener('submit', (e) => {
        const li = document.querySelector(`#${socket.id}`);

        e.preventDefault();

        const message = {
          chatMessage: inputMessage.value,
          nickname: li.innerText,
        };

        socket.emit('message', message);
        inputMessage.value = '';
        return false;
      });

      const createMessage = (message, id) => {
        const ul = document.querySelector('#messages');
        const li = document.createElement('li');
        console.log(id)
        li.innerText = message;
        li.setAttribute('data-testid', 'message');
        li.setAttribute('id', id);
        ul.appendChild(li);
      };

      socket.on('message', (message, id) => {
        createMessage(message, id);
      });

    </script>
  </body>
</html>
